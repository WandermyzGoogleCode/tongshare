<% content_for :js_ext do %>
  <%= javascript_include_tag "sharing.js" %>
  <%= javascript_include_tag "event.js" %>
<% end %>

  <div class="sharing title"><%= @event.name %></div>

<%= content_box "通过短信分享", "活动", true do %>
    <p>您可以将下面的文字直接通过短信、飞信等形式群发给受邀请者，同享日程将在他们接受该邀请后在共同参与者中显示他们的名字。
    如果您还想进一步知道哪些人拒绝了该活动，哪些人没有回复邀请，请在“通过短信分享活动”邀请他们的同时，也通过“通过学号、邮箱分享活动”来邀请他们。</p>
    <%= link_to "展开/关闭邀请模板", "javascript: hide_or_show('invitation_message')" %>
    <div id ="invitation_message" class="invitation_message">
      <p><%= @current_user.friendly_name %>邀请你参加活动“<%= @event.name %>”
      </p>

      <p>
      时间：<%= @friendly_time_range %>

      <% if @event.recurring? %>
      <br/>重复：<%=  show_friendly_rrule(@event) %>
      <% end %>

      <%if !@event.location.blank?%>
      <br/>地点：<%= @event.location %>
      <%end%>

      <%if !@event.extra_info.blank? %>
      <br/><%=  @event.extra_info%>
      <%end%>
      </p>

      <p>查看更多活动信息并对该邀请进行回复，请进入链接：<br/><%= "http://" + SITE + event_path(@event) + "?share_token=" + @event.get_or_create_share_token %></p>
    </div>
<% end %>
<br/>

<%= content_box "通过学号、邮箱分享", "活动", true do %>

  <%= form_tag url_for(:action => "add_members"), :remote => true do %>
      <fieldset>
        <%= hidden_field_tag "event_id", @event.id %>
        <div class="field">
          <label for="raw_string" class="title">学号,邮箱</label>
          <%= text_area_tag "raw_string", nil, :class=>"textfield_narrow", :onkeyup=>"raw_string_onkeyup(typeof(e)=='undefined'?event:(e || event));", :onblur=>"raw_string_onblur();"%>
        </div>
        <div class="field">
          <label class="title">&nbsp;</label>
          <div class="field_help">粘贴或填写学号或电子邮件地址，使用逗号、分号、空格、制表符或换行符分隔</div>
        </div>
        <div class="field">
          <label class="title">&nbsp;</label>
    <%#= submit_button nil, "add_members_form", "添加"%>
          <%= submit_tag "添加", :id => "add_members_submit" %>
        </div>
      </fieldset>
    <% end %>

  <%= form_for(@sharing, :html => {:onsubmit => 'return checkFormValid(this);'} ) do |f| %>
    <fieldset>
        <% if @sharing.errors.any? %>
          <div id="error_explanation">
            <h2><%= I18n.t 'activerecord.errors.template.header', :count => @sharing.errors.count %></h2>

            <ul>
              <% @sharing.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

      <%= f.hidden_field :event_id%>
        
      <div class="field">
        <label class="title">邀请对象</label>
        <div id="new_member_nil" class="field_div">（请在上面的文本框中添加邀请对象，完成后单击“添加”按钮）</div>
        <div id="new_members_container" class="field_div">
          <ul id="new_members">
          </ul>
          <br/>
        </div>
        <div id="new_dummy_container" class="field_div" style="display:none">
          以下用户没有注册或者没有通过身份验证，他们将在注册或验证完成后收到您的活动分享：
          <ul id="new_dummy"></ul>
           <br/>
        </div>
        <div id="new_email_container" class="field_div" style="display:none">
          以下邮箱没有被绑定到已注册用户，但是同享日程仍会发送邀请邮件：
          <ul id="new_email"></ul>
           <br/>
        </div>

        <div id="errors_container">
          <div id="errors_invalid_container" class="field_div" style="display:none">
            以下用户没有注册且无法获取其学号或电子邮件，因此无法收到活动分享：
            <ul id="errors_invalid"></ul>
             <br/>
          </div>
          <div id="errors_duplicated_container" class="field_div" style="display:none">
            以下用户已经被分享过此活动，将不会再次发送分享：
            <ul id="errors_duplicated"></ul>
             <br/>
          </div>
          <div id="errors_parse_errored_container" class="field_div" style="display:none">
            无法解析以下字串：
            <ul id="errors_parse_errored"></ul>
             <br/>
          </div>
        </div>
      </div>

      <div class="field">
        <%= f.label :extra_info, :class=>"title" %>
        <%= f.text_area :extra_info, :class=>"textfield_narrow"%>
      </div>


        <%= submit_button form, "new_sharing", "提交"%>
        <%#TODO: check if the user clicked "添加" %>
        <%= styled_button "取消", :back %>
      <% end %>
    </fieldset>
<% end %>